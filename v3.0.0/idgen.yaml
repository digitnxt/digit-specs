openapi: 3.0.0
info:
  title: ID Generator Service API
  version: 3.0.0
  description: |
    A DIGIT microservice that generates unique, human-readable IDs from user-defined templates. 
    It supports formatted dates, scoped and padded sequences (Postgres-backed for concurrency safety), 
    random segments with flexible charsets, and dynamic variable substitution.
    
servers:
  - url: http://localhost:8080/idgen
    description: Local development server
  - url: https://api.example.com/idgen
    description: Production server

security:
  - BearerAuth: []

tags:
  - name: Template Management
    description: Operations for managing ID generation templates
  - name: ID Generation
    description: Operations for generating IDs from templates

paths:
  /v1/template:
    post:
      tags:
        - Template Management
      summary: Create a new ID generation template
      description: |
        Registers a new ID generation template with configuration and initializes its sequence.
        Creates version v1 of the template.
      operationId: createTemplate
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/ClientIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IDGenTemplateRequest'
            examples:
              receiptId:
                summary: Receipt ID Template
                value:
                  templateCode: "receipt-id"
                  config:
                    template: "{tenant}-{DATE:yyyy-mm-dd}-{SEQ}-{RAND}"
                    sequence:
                      scope: "daily"
                      start: 1
                      padding:
                        length: 6
                        char: "0"
                    random:
                      length: 4
                      charset: "A-Z0-9"
              orgId:
                summary: Organization ID Template
                value:
                  templateCode: "orgId"
                  config:
                    template: "{ORG}-{DATE:yyyyMMdd}-{SEQ}-{RAND}"
                    sequence:
                      scope: "daily"
                      start: 1
                      padding:
                        length: 4
                        char: "0"
                    random:
                      length: 2
                      charset: "A-Z0-9"
      responses:
        '201':
          description: Template created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IDGenTemplateResponse'
              example:
                id: "550e8400-e29b-41d4-a716-446655440000"
                tenantId: "pg"
                templateCode: "receipt-id"
                version: "v1"
                config:
                  template: "{tenant}-{DATE:yyyy-mm-dd}-{SEQ}-{RAND}"
                  sequence:
                    scope: "daily"
                    start: 1
                    padding:
                      length: 6
                      char: "0"
                  random:
                    length: 4
                    charset: "A-Z0-9"
                auditDetails:
                  createdBy: "550e8400-e29b-41d4-a716-446655440000"
                  createdTime: 1704067200000
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict (duplicate code within tenant)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    put:
      tags:
        - Template Management
      summary: Update an existing template
      description: |
        Creates a new immutable version of an existing template's configuration.
        Increments the version number (e.g., v1 -> v2).
      operationId: updateTemplate
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/ClientIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IDGenTemplateRequest'
            example:
              templateCode: "orgId"
              config:
                template: "{ORG}-{DATE:yyyyMMdd}-{SEQ}-{RAND}"
                sequence:
                  scope: "daily"
                  start: 1
                  padding:
                    length: 3
                    char: "0"
                random:
                  length: 3
                  charset: "A-Z0-9"
      responses:
        '201':
          description: Template updated successfully (new version created)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IDGenTemplateResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    get:
      tags:
        - Template Management
      summary: Search templates
      description: |
        Search for templates by various criteria.
        
        **Search Behavior:**
        - If only tenantId is provided: returns latest version of each template
        - If templateCode is provided without version: returns latest version of that template
        - If ids are provided: returns those specific template rows
        - If version is provided: templateCode is required
      operationId: searchTemplates
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: templateCode
          in: query
          description: Template code to search for
          schema:
            type: string
          example: "orgId"
        - name: ids
          in: query
          description: Comma-separated list of template UUIDs
          schema:
            type: string
          example: "da880db9-369e-484d-b4d0-37c6274485dd,bea96bb4-a4ec-449e-8b60-9e79869e2700"
        - name: version
          in: query
          description: Template version (requires templateCode)
          schema:
            type: string
            pattern: '^v\d+$'
          example: "v1"
      responses:
        '200':
          description: Templates found
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/IDGenTemplateResponse'
              example:
                - id: "550e8400-e29b-41d4-a716-446655440000"
                  tenantId: "pg"
                  templateCode: "orgId"
                  version: "v1"
                  config:
                    template: "{ORG}-{DATE:yyyyMMdd}-{SEQ}-{RAND}"
                    sequence:
                      scope: "daily"
                      start: 1
                      padding:
                        length: 4
                        char: "0"
                    random:
                      length: 2
                      charset: "A-Z0-9"
                  auditDetails:
                    createdBy: "550e8400-e29b-41d4-a716-446655440000"
                    createdTime: 1704067200000
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    delete:
      tags:
        - Template Management
      summary: Delete a template version
      description: |
        Delete a specific version of a template.
        
        **Deletion Semantics:**
        - Deleting a non-latest version: only that versioned row is removed
        - Deleting the latest version when other versions exist: only the latest row is removed
        - Deleting the only version: template, scope resets, sequence lookup, and Postgres sequence are fully cleaned up
      operationId: deleteTemplate
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: templateCode
          in: query
          required: true
          description: Template code to delete
          schema:
            type: string
          example: "orgId"
        - name: version
          in: query
          required: true
          description: Template version to delete
          schema:
            type: string
            pattern: '^v\d+$'
          example: "v2"
      responses:
        '200':
          description: Template deleted successfully
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /v1/generate:
    post:
      tags:
        - ID Generation
      summary: Generate an ID from a template
      description: |
        Generates a unique ID from a registered template using optional variables.
        Uses the latest version of the template for the given tenant.
      operationId: generateId
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateIDRequest'
            examples:
              withVariables:
                summary: Generate with variables
                value:
                  templateCode: "receipt-id"
                  variables:
                    tenant: "pb"
                    dept: "REV"
              orgId:
                summary: Generate organization ID
                value:
                  templateCode: "orgId"
                  variables:
                    ORG: "PG"
      responses:
        '200':
          description: ID generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateIDResponse'
              examples:
                receiptId:
                  summary: Receipt ID generated
                  value:
                    tenantId: "pb"
                    templateCode: "receipt-id"
                    version: "v3"
                    id: "pb-2025-09-22-000123-A9XZ"
                orgId:
                  summary: Organization ID generated
                  value:
                    tenantId: "pg"
                    templateCode: "orgId"
                    version: "v1"
                    id: "PG-20250703-0001-A9"
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Generation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    BearerAuth:
      $ref: 'https://raw.githubusercontent.com/egovernments/DIGIT-3.0/master/common-3.0.0.yaml#/components/securitySchemes/BearerAuth'

  parameters:
    TenantIdHeader:
      $ref: 'https://raw.githubusercontent.com/digitnxt/digit3/refs/heads/master/docs/services/common/Common-3.0.0.yaml#/components/parameters/TenantIdHeader'
    
    ClientIdHeader:
      $ref: 'https://raw.githubusercontent.com/digitnxt/digit3/refs/heads/master/docs/services/common/Common-3.0.0.yaml#/components/parameters/ClientId'
  
  schemas:
    IDGenTemplateRequest:
      type: object
      required:
        - templateCode
        - config
      properties:
        templateCode:
          type: string
          description: Unique identifier for the template
          example: "receipt-id"
        config:
          $ref: '#/components/schemas/IDGenTemplateConfig'
    
    IDGenTemplateResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for this template version
          example: "550e8400-e29b-41d4-a716-446655440000"
        tenantId:
          type: string
          description: Tenant identifier
          example: "pg"
        templateCode:
          type: string
          description: Template code
          example: "receipt-id"
        version:
          type: string
          pattern: '^v\d+$'
          description: Template version
          example: "v1"
        config:
          $ref: '#/components/schemas/IDGenTemplateConfig'
        auditDetails:
          $ref: '#/components/schemas/AuditDetails'
    
    IDGenTemplateConfig:
      type: object
      required:
        - template
      properties:
        template:
          type: string
          description: |
            Template pattern containing static text and dynamic tokens.
            
            **Supported Tokens:**
            - `{VARIABLE}`: Client-supplied variable (e.g., {ORG}, {tenant}, {dept})
            - `{DATE:format}`: Current date with format keyword
            - `{SEQ}`: Sequence counter (scoped and padded via config)
            - `{RAND}`: Random string (from configured charset)
            
            **Date Format Keywords:**
            - yyyymmdd, ddmmyyyy, yyyy-mm-dd, dd-mm-yyyy
            - yyyy/mm/dd, dd/mm/yyyy, yyyy.mm.dd, dd.mm.yyyy
            - mmyyyy, mm-yyyy, yyyy-mm, yyyy, yy
          example: "{ORG}-{DATE:yyyyMMdd}-{SEQ}-{RAND}"
        sequence:
          $ref: '#/components/schemas/SequenceConfig'
        random:
          $ref: '#/components/schemas/RandomConfig'
    
    SequenceConfig:
      type: object
      properties:
        scope:
          type: string
          enum: [global, daily, monthly, yearly]
          default: global
          description: When the counter resets
          example: "daily"
        start:
          type: integer
          minimum: 1
          default: 1
          description: Initial value when sequence is first used or after reset
          example: 1
        padding:
          $ref: '#/components/schemas/PaddingConfig'
    
    PaddingConfig:
      type: object
      properties:
        length:
          type: integer
          minimum: 1
          description: Minimum width in characters
          example: 4
        char:
          type: string
          minLength: 1
          maxLength: 1
          default: "0"
          description: Character used for left-padding
          example: "0"
    
    RandomConfig:
      type: object
      properties:
        length:
          type: integer
          minimum: 0
          default: 0
          description: Number of random characters to generate
          example: 2
        charset:
          type: string
          description: |
            Allowed characters for random generation.
            Supports ranges like A-Z, a-z, 0-9 and combinations like A-Za-z0-9
          example: "A-Z0-9"
    
    GenerateIDRequest:
      type: object
      required:
        - templateCode
      properties:
        templateCode:
          type: string
          description: Template code to use for ID generation
          example: "receipt-id"
        variables:
          type: object
          additionalProperties:
            type: string
          description: Map of variable names to values for token substitution
          example:
            tenant: "pb"
            dept: "REV"
    
    GenerateIDResponse:
      type: object
      properties:
        tenantId:
          type: string
          description: Tenant identifier
          example: "pb"
        templateCode:
          type: string
          description: Template code used
          example: "receipt-id"
        version:
          type: string
          pattern: '^v\d+$'
          description: Template version used
          example: "v3"
        id:
          type: string
          description: Generated unique ID
          example: "pb-2025-09-22-000123-A9XZ"
    
    AuditDetails:
      $ref: 'https://raw.githubusercontent.com/digitnxt/digit3/refs/heads/master/docs/services/common/Common-3.0.0.yaml#/components/schemas/AuditDetail'
    
    Error:
      $ref: 'https://raw.githubusercontent.com/digitnxt/digit3/refs/heads/master/docs/services/common/Common-3.0.0.yaml#/components/schemas/Error'
  